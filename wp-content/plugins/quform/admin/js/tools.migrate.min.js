var quform=function(e,t,r,a){"use strict";var i,o=e.core,s=o.cache,n=!1,g=[],m=1,f=0,c=!0;return i={init:function(){s.get("#qfb_migrate_forms").change(function(){s.get("#qfb_migrate_forms_custom").closest(o.settingWrap)["specific"==s.get("#qfb_migrate_forms").val()?"qfbSlideShow":"qfbSlideHide"]()}),t.fn.select2&&s.get("#qfb_migrate_forms_custom").select2({theme:"qfb",language:{noResults:function(){return a.noResultsFound}}}),s.get("#qfb-migrate-start").click(i.startMigration),s.get("#qfb-migrate-stop").click(function(){c=!1,s.get("#qfb-migrate-stop-text").text(r.stopping)}),s.get("#qfb-migrate-close").click(function(){s.get("#qfb-migrate-progress").hide(),s.get("body").css("overflow",""),s.get("#qfb-migrate-progress-bar-inner").width(0),s.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-info"),s.get("#qfb-migrate-current-task-text").text(r.processing),s.get("#qfb-migrate-close").hide(),s.get("#qfb-migrate-stop-text").text(r.stopMigration),s.get("#qfb-migrate-progress").find(".qfb-submission-error").remove(),s.get("#qfb-migrate-errors").empty()}),s.get("#qfb-import-form-button").click(i["import"])},startMigration:function(){var e;s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),"specific"!=s.get("#qfb_migrate_forms").val()||(e=s.get("#qfb_migrate_forms_custom").val(),t.isArray(e)&&e.length)?(s.get("#qfb-migrate-progress").show(),s.get("body").css("overflow","hidden"),s.get("#qfb-migrate-progress-bar-inner").width(0),s.get("#qfb-migrate-current-task-text").text(r.processing),"specific"==s.get("#qfb_migrate_forms").val()?(e=t.map(e,function(e){return parseInt(e,10)}),i.migrateForms(e)):t.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_migrate_get_all_form_ids"},dataType:"json"}).done(function(e){"success"==(e=o.sanitiseResponse(e)).type&&t.isArray(e.formIds)&&e.formIds.length?i.migrateForms(e.formIds):i.migrationFailed(e.message)}).fail(function(){i.migrationFailed(a.ajaxError)}),(s.get("#qfb_migrate_license").is(":checked")||s.get("#qfb_migrate_recaptcha_keys").is(":checked"))&&t.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_migrate_settings",_ajax_nonce:r.migrateSettingsNonce,migrate_license_key:s.get("#qfb_migrate_license").is(":checked")?"1":"0",migrate_recaptcha_keys:s.get("#qfb_migrate_recaptcha_keys").is(":checked")?"1":"0"},dataType:"json"}).done(function(e){"error"==(e=o.sanitiseResponse(e)).type&&o.addValidationError(s.get("#qfb-migrate-errors"),r.errorMigratingKeys.replace("%s",e.message))}).fail(function(){o.addValidationError(s.get("#qfb-migrate-errors"),r.errorMigratingKeys.replace("%s",a.ajaxError))})):o.addValidationError(s.get("#qfb_migrate_forms_custom").closest(o.settingInputWrap),a.thisFieldIsRequired)},migrateForms:function(e){g=e,f=e.length,m=1,c=!0,s.get("#qfb-migrate-stop").css("display","inline-block"),i.migrateForm(g.shift())},migrateForm:function(e){t.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_migrate_form",_ajax_nonce:r.migrateNonce,form_id:e,migrate_entries:s.get("#qfb_migrate_entries").is(":checked")?"1":"0"},dataType:"json"}).done(function(t){i.updateStatus(e,o.sanitiseResponse(t))}).fail(function(){i.updateStatus(e,{type:"error",message:a.ajaxError})})},updateStatus:function(e,t){var a=Math.round(m/f*100);s.get("#qfb-migrate-progress-bar-inner").width(a+"%"),m++,"error"==t.type&&o.addValidationError(s.get("#qfb-migrate-errors"),r.errorMigratingForm.replace("%d",e).replace("%s",t.message)),g.length&&c?i.migrateForm(g.shift()):i.migrationCompleted()},migrationCompleted:function(){s.get("#qfb-migrate-stop").hide(),s.get("#qfb-migrate-close").css("display","inline-block"),c?(s.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-success"),s.get("#qfb-migrate-current-task-text").text(r.migrationCompleted)):s.get("#qfb-migrate-current-task-text").text(r.migrationStopped)},migrationFailed:function(e){s.get("#qfb-migrate-stop").hide(),s.get("#qfb-migrate-close").css("display","inline-block"),o.addSubmissionError(s.get("#qfb-migrate-progress-inner"),r.errorStartingMigration.replace("%s",e)),s.get("#qfb-migrate-current-task").attr("class","qfb-message-box qfb-message-box-error"),s.get("#qfb-migrate-current-task-text").text(r.migrationError)},validate:function(){if(s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),""===s.get("#qfb-import-form-data").val()){var e=s.get("#qfb-import-form-data").closest(o.settingWrap);return o.addValidationError(e,a.thisFieldIsRequired),o.scrollTo(e),!1}return!0},"import":function(){if(!n){if(!i.validate())return!1;n=!0,t.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_migrate_import_form",_ajax_nonce:r.migrateImportFormNonce,config:s.get("#qfb-import-form-data").val()},dataType:"json"}).done(function(e){e=o.sanitiseResponse(e),s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),n=!1,"success"==e.type?i.onImportSuccess(e.message):"error"!=e.type&&"invalid"!=e.type||i.onImportFail(e)}).fail(function(){s.get(".qfb-tools-migrate").find(".qfb-validation-error").remove(),n=!1,i.onImportFail({message:a.ajaxError})})}},onImportSuccess:function(e){o.showFixedMessage(e,"success",0)},onImportFail:function(e){var a;o.isNonEmptyString(e.message)&&o.showFixedMessage(r.errorImportingForm+"<br>"+e.message,"error"),e.errors&&t.each(e.errors,function(e,t){var r=s.get("#"+e).closest(o.settingWrap);a||(a=r),o.addValidationError(r,t)}),a&&o.scrollTo(a)}},t(document).ready(i.init),e.tools=e.tools||{},e.tools.migrate=i,e}(quform,jQuery,quformToolsMigrateL10n,quformCoreL10n);